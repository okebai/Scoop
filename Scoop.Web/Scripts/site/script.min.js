var stringToFunction,UUID,Scoop;(function(n){var t=function(){function n(){this.connectionCookieName="connections"}return n.prototype.storeConnection=function(n){var t,i,r;n.guid()==null&&n.guid(UUID.generate());t=Cookies.getJSON(this.connectionCookieName)||[];i=n.guid();t=t.filter(function(n){return n.guid!=i});r=this.toSerializable(n);t.push(r);this.storeCookie(t)},n.prototype.removeConnectionFromStore=function(n){var t=Cookies.getJSON(this.connectionCookieName)||[],i=n.guid();t=t.filter(function(n){return n.guid!=i});this.storeCookie(t)},n.prototype.storeCookie=function(n){var t=moment().add(1,"year").toDate();Cookies.set(this.connectionCookieName,n,{expires:t})},n.prototype.getConnectionsFromStore=function(){return Cookies.getJSON(this.connectionCookieName)||[]},n.prototype.getAvailableTasks=function(n){return $.ajax({url:n+"/AvailableTasks",method:"GET",cache:!1})},n.prototype.connect=function(n){var t,i,r;return this.disconnect(n),console.log("connect",n.guid()),t=$.hubConnection(n.uri()),i=$.Deferred(),$.each(n.chosenTasks(),function(r,u){var f=null;u.hubName!=null&&(f=t.createHubProxy(u.hubName),i.done(function(){u.onConnect(f)}));u.init(f,n)}),t.logging=!1,r=t.start(),r.done(function(){n.currentHubConnection=t;i.resolve()}),r},n.prototype.disconnect=function(n){$.each(n.chosenTasks(),function(t,i){i.onDisconnect(n)});n.currentHubConnection&&n.currentHubConnection.stop();n.currentHubConnection=null},n.prototype.toSerializable=function(n){return{guid:n.guid(),uri:n.uri(),name:n.name(),autoConnect:n.autoConnect(),isConnected:n.isConnected(),hasConnectionProblem:n.hasConnectionProblem(),connectionProblemMessage:n.connectionProblemMessage()}},n.fromSerializable=function(n){var t=ko.viewmodel.fromModel(n);return n.hasOwnProperty("hasConnectionProblem")||(t.hasConnectionProblem=ko.observable()),n.hasOwnProperty("connectionProblemMessage")||(t.connectionProblemMessage=ko.observable()),t.availableTasks=ko.observableArray(),t.isConnected=ko.observable(),t},n.clone=function(n){return{guid:ko.observable(n.guid()),uri:ko.observable(n.uri()),name:ko.observable(n.name()),autoConnect:ko.observable(n.autoConnect()),isConnected:ko.observable(n.isConnected()),hasConnectionProblem:ko.observable(n.hasConnectionProblem()),connectionProblemMessage:ko.observable(n.connectionProblemMessage())}},n}();n.ConnectionService=t})(Scoop||(Scoop={})),function(n){var t=function(){function t(t){var i=this;this.updateAllConnectionsFromStore=function(){var t=i.connectionService.getConnectionsFromStore();i.connections.remove(function(n){return $.grep(t,function(t){return t.guid==n.guid()}).length==0});$.each(t,function(t,r){i.connectionService.getAvailableTasks(r.uri).done(function(t){var o=$.map(t,function(n){var t=null,r;return i.tasksCache[n.guid]?t=i.tasksCache[n.guid]:n.name!=null&&(r=stringToFunction("Scoop."+n.name),r&&(t=new r)),t}),f=ko.observableArray(o),e=$.grep(i.connections(),function(n){return n.guid()==r.guid}),u;e.length?$.each(e,function(n,t){t.autoConnect(r.autoConnect);t.name(r.name);t.uri(r.uri);t.availableTasks=f;t.chosenTasks=ko.observableArray($.map(t.chosenTasks(),function(n){return $.grep(f(),function(t){return t.guid==n.guid}).length?n:null}));t.hasConnectionProblem(!1);t.connectionProblemMessage(null);t.autoConnect()&&i.connect(t)}):(u=n.ConnectionService.fromSerializable(r),u.availableTasks=f,u.chosenTasks=f,i.connections.push(u),u.autoConnect()&&i.connect(u))}).fail(function(t,u,f){var o=$.grep(i.connections(),function(n){return n.guid()==r.guid}),e;o.length?$.each(o,function(n,i){i.autoConnect(r.autoConnect);i.name(r.name);i.uri(r.uri);i.availableTasks.removeAll();i.chosenTasks.removeAll();i.hasConnectionProblem(!0);t.status==0?i.connectionProblemMessage("Network error. Please check console for details."):i.connectionProblemMessage(t.status+" "+f)}):(e=n.ConnectionService.fromSerializable(r),e.availableTasks=ko.observableArray(),e.chosenTasks=ko.observableArray(),e.hasConnectionProblem(!0),t.status==0?e.connectionProblemMessage("Network error. Please check console for details."):e.connectionProblemMessage(t.status+" "+f),i.connections.push(e))})})};this.addOrUpdateConnection=function(t){var r=$.grep(i.connections(),function(n){return n.guid()==t.guid()});return i.connectionService.getAvailableTasks(t.uri()).done(function(u){var o=$.map(u,function(n){var t=null,r;return i.tasksCache[n.guid]?t=i.tasksCache[n.guid]:n.name!=null&&(r=stringToFunction("Scoop."+n.name),r&&(t=new r)),t}),e=ko.observableArray(o),f;r.length?$.each(r,function(n,r){r.autoConnect(t.autoConnect());r.name(t.name());r.uri(t.uri());r.availableTasks=e;r.chosenTasks=ko.observableArray($.map(r.chosenTasks(),function(n){return $.grep(e(),function(t){return t.guid==n.guid}).length?n:null}));r.hasConnectionProblem(!1);r.connectionProblemMessage(null);i.connectionService.storeConnection(r);r.autoConnect()&&i.connect(r)}):(f=n.ConnectionService.clone(t),f.availableTasks=e,f.chosenTasks=e,i.connections.push(f),i.connectionService.storeConnection(f),f.autoConnect()&&i.connect(f))}).fail(function(u,f,e){if(r.length)$.each(r,function(n,r){r.autoConnect(t.autoConnect());r.name(t.name());r.uri(t.uri());r.availableTasks.removeAll();r.chosenTasks.removeAll();r.hasConnectionProblem(!0);u.status==0?r.connectionProblemMessage("Network error. Please check console for details."):r.connectionProblemMessage(u.status+" "+e);i.connectionService.storeConnection(r)});else{var o=n.ConnectionService.clone(t);o.hasConnectionProblem(!0);u.status==0?o.connectionProblemMessage("Network error. Please check console for details."):o.connectionProblemMessage(u.status+" "+e);i.connections.push(o);i.connectionService.storeConnection(o)}})};this.addConnection=function(){console.log("addConnection",i.newConnection.uri());i.addOrUpdateConnection(i.newConnection).done(function(){i.resetNewConnection()}).fail(function(){})};this.removeConnection=function(n){console.log("removeConnection",n.uri());n.isConnected()&&i.disconnect(n);i.connections.remove(n);i.connectionService.removeConnectionFromStore(n)};this.connect=function(n){console.log("connect");i.connectionService.connect(n).done(function(){n.isConnected(!0)})};this.disconnect=function(n){console.log("disconnect");i.connectionService.disconnect(n);n.isConnected(!1)};this.enableAutoConnect=function(n){console.log("enableAutoConnect");n.autoConnect(!0);i.connectionService.storeConnection(n);i.connect(n)};this.disableAutoConnect=function(n){console.log("disableAutoConnect");n.autoConnect(!1);i.connectionService.storeConnection(n)};this.connectionService=t;this.resetNewConnection();this.connections=ko.observableArray([]);this.tasksCache={};this.updateAllConnectionsFromStore()}return t.prototype.resetNewConnection=function(){this.newConnection?(this.newConnection.guid(null),this.newConnection.uri(""),this.newConnection.name(""),this.newConnection.autoConnect(!1),this.newConnection.isConnected(!1),this.newConnection.hasConnectionProblem(!1),this.newConnection.connectionProblemMessage(null)):this.newConnection=ko.viewmodel.fromModel({guid:null,uri:"",name:"",autoConnect:!1,isConnected:!1,hasConnectionProblem:!1,connectionProblemMessage:""})},t}();n.ConnectionViewModel=t}(Scoop||(Scoop={})),function(n){var t=function(){function n(){}return n.prototype.init=function(){},n.prototype.onConnect=function(){},n.prototype.onDisconnect=function(){},n}();n.AutoUpdateTask=t}(Scoop||(Scoop={})),function(n){var t=function(){function n(){this.hubName="performanceHub";this.charts={};this.performanceData={}}return n.prototype.init=function(n,t){var i=this;if(n!=null){n.on("updatePerformance",function(n,r,u){i.updatePerformanceData(t,n,r,u);i.updatePerformanceChart(t)});n.on("updatePerformanceHistory",function(n){var r,u;for(i.clearPerformanceData(t),r=0;r<n.length;r++)u=n[r],i.updatePerformanceData(t,u.Name,u.Values,u.Timestamp);i.updatePerformanceChart(t)})}},n.prototype.onConnect=function(n){n!=null&&n.invoke("GetPerformanceHistory")},n.prototype.onDisconnect=function(n){this.removePerformanceChart(n)},n.prototype.clearPerformanceData=function(n){delete this.performanceData[n.guid()]},n.prototype.updatePerformanceData=function(n,t,i,r){var u=n.guid(),e,f;for(this.performanceData[u]||(this.performanceData[u]=[[],[],[]]),e=moment().add(-3,"minutes"),f=0;f<this.performanceData[u].length;f++)this.performanceData[u][f]=$.grep(this.performanceData[u][f],function(n){return moment(n.x).isAfter(e)});this.performanceData[u][0].push({x:moment(r).toDate(),y:i["0"]/100});this.performanceData[u][1].push({x:moment(r).toDate(),y:i["1"]});this.performanceData[u][2].push({x:moment(r).toDate(),y:i["2"]/.1})},n.prototype.removePerformanceChart=function(n){var t=n.guid(),i="chart-target-"+t;this.charts[i]&&(this.charts[i].detach(),delete this.charts[i]);$("#chart-container-"+t).remove();delete this.performanceData[t]},n.prototype.updatePerformanceChart=function(n){var u,r,t,i,f;for(console.log("updatePerformanceChart",n.name(),n.guid()),u=[],r=n.guid(),t=0;t<this.performanceData[r].length;t++)this.performanceData[r][t]!=null&&u.push({name:"series"+t,data:this.performanceData[r][t]});i="chart-target-"+r;f=$("#"+i);f.length?(this.charts[i].data={series:u},this.charts[i].update()):this.charts[i]=this.createChart(n,i,{series:u})},n.prototype.createChart=function(n,t,i){var r=$(".chart-container",".performance-task-template").clone(),u;return r.attr("id","chart-container-"+n.guid()),$(".name",r).text(n.name()),$(".uri",r).text(n.uri()),u=$(".chart-target",r),u.attr("id",t),$(".dashboard-container").append(r),new Chartist.Line("#"+t,i,{showArea:!0,showPoint:!1,axisX:{type:Chartist.FixedScaleAxis,divisor:6,labelInterpolationFnc:function(n){return moment(n).format("HH:mm:ss")}},axisY:{type:Chartist.FixedScaleAxis,high:1,low:0,ticks:[0,.1,.25,.5,.75,.9,1],labelInterpolationFnc:function(n){return Math.round(n*100)+" %"}}})},n}();n.PerformanceTask=t}(Scoop||(Scoop={})),function(n){var t=function(){function n(){}return n.prototype.init=function(){},n.prototype.onConnect=function(){},n.prototype.onDisconnect=function(){},n}();n.ServerStatusTask=t}(Scoop||(Scoop={}));stringToFunction=function(n){for(var r=n.split("."),t=window||this,i=0,u=r.length;i<u;i++)t=t[r[i]];if(typeof t!="function")throw new Error("function not found: '"+n+"'");return t};UUID=function(){for(var n=[],t=0;t<256;t++)n[t]=(t<16?"0":"")+t.toString(16);return{generate:function(){var t=Math.random()*4294967295|0,i=Math.random()*4294967295|0,r=Math.random()*4294967295|0,u=Math.random()*4294967295|0;return n[t&255]+n[t>>8&255]+n[t>>16&255]+n[t>>24&255]+"-"+n[i&255]+n[i>>8&255]+"-"+n[i>>16&15|64]+n[i>>24&255]+"-"+n[r&63|128]+n[r>>8&255]+"-"+n[r>>16&255]+n[r>>24&255]+n[u&255]+n[u>>8&255]+n[u>>16&255]+n[u>>24&255]}}}(),function(){}(Scoop||(Scoop={}));$(function(){ko.bindingHandlers.select2=new function(){this.init=function(n,t){var r=t(),i=$(n);i.select2(r);ko.utils.domNodeDisposal.addDisposeCallback(n,function(){i.select2("destroy")})};this.update=function(n,t,i){i().selectedOptions();$(n).trigger("change")}};var n=new Scoop.ConnectionService,t=new Scoop.ConnectionViewModel(n);ko.applyBindings(t)});