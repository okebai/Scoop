var stringToFunction,Scoop;(function(n){var t=function(){function n(){}return n.prototype.addConnection=function(n){var t=new FormData;return t.append("connection.name",n.name()),t.append("connection.uri",n.uri()),t.append("connection.autoConnect",n.autoConnect()),t.append("__RequestVerificationToken",$("input[name=__RequestVerificationToken]").val()),$.ajax({url:"/Connection/Add",method:"POST",cache:!1,contentType:!1,processData:!1,data:t})},n.prototype.getConnections=function(){return $.ajax({url:"/Connection/List",method:"GET"})},n.prototype.getAvailableTasks=function(n){return $.ajax({url:n.uri()+"/AvailableTasks",method:"GET",cache:!1})},n.prototype.connect=function(n){var t,i,r;return this.disconnect(n),console.log("connect",n.guid()),t=$.hubConnection(n.uri()),i=$.Deferred(),$.each(n.chosenTasks(),function(r,u){var f=null;u.hubName!=null&&(f=t.createHubProxy(u.hubName),i.done(function(){u.onConnect(f)}));u.init(f,n)}),t.logging=!1,r=t.start(),r.done(function(){n.currentHubConnection=t;i.resolve()}),r},n.prototype.disconnect=function(n){$.each(n.chosenTasks(),function(t,i){i.onDisconnect(n)});n.currentHubConnection&&n.currentHubConnection.stop();n.currentHubConnection=null},n}();n.ConnectionService=t})(Scoop||(Scoop={})),function(n){var t=function(){function n(n){var t=this;this.updateConnections=function(){t.connectionService.getConnections().done(function(n){var i=ko.viewmodel.fromModel(n,{extend:{"{root}[i]":function(n){n.isConnected=ko.observable(!1);n.currentHubConnection=null;n.chosenTasks=ko.observableArray([])}}});t.connections.remove(function(n){return $.grep(i(),function(t){return t.guid()==n.guid()}).length==0});$.each(i(),function(n,i){t.connectionService.getAvailableTasks(i).done(function(n){var f=$.map(n,function(n){var i=null,r;return t.tasksCache[n.guid]?i=t.tasksCache[n.guid]:n.name!=null&&(r=stringToFunction("Scoop."+n.name),r&&(i=new r)),i}),r=ko.observableArray(f),u=$.grep(t.connections(),function(n){return n.guid()==i.guid()});u.length?$.each(u,function(n,t){t.autoConnect(i.autoConnect());t.name(i.name());t.uri(i.uri());t.availableTasks=r;t.chosenTasks=ko.observableArray($.map(t.chosenTasks(),function(n){return $.grep(r(),function(t){return t.guid==n.guid}).length?n:null}))}):(i.availableTasks=r,i.chosenTasks=r,t.connections.push(i))})})})};this.addConnection=function(){console.log("addConnection",t.newConnection.uri());t.connectionService.addConnection(t.newConnection).done(function(){t.updateConnections()})};this.connect=function(n){console.log("connect",n);t.connectionService.connect(n).done(function(){n.isConnected(!0)})};this.disconnect=function(n){console.log("disconnect");t.connectionService.disconnect(n);n.isConnected(!1)};this.connectionService=n;this.newConnection=ko.viewmodel.fromModel({uri:"",name:"",autoConnect:!1});this.connections=ko.observableArray([]);this.tasksCache={};this.updateConnections()}return n}();n.ConnectionViewModel=t}(Scoop||(Scoop={})),function(n){var t=function(){function n(){}return n.prototype.init=function(){},n.prototype.onConnect=function(){},n.prototype.onDisconnect=function(){},n}();n.AutoUpdateTask=t}(Scoop||(Scoop={})),function(n){var t=function(){function n(){this.hubName="performanceHub";this.charts={};this.performanceData={}}return n.prototype.init=function(n,t){var i=this;if(n!=null){n.on("updatePerformance",function(n,r,u){i.updatePerformanceData(t,n,r,u);i.updatePerformanceChart(t)});n.on("updatePerformanceHistory",function(n){var r,u;for(i.clearPerformanceData(t),r=0;r<n.length;r++)u=n[r],i.updatePerformanceData(t,u.Name,u.Values,u.Timestamp);i.updatePerformanceChart(t)})}},n.prototype.onConnect=function(n){n!=null&&n.invoke("GetPerformanceHistory")},n.prototype.onDisconnect=function(n){this.removePerformanceChart(n)},n.prototype.clearPerformanceData=function(n){delete this.performanceData[n.guid()]},n.prototype.updatePerformanceData=function(n,t,i,r){var u=n.guid(),e,f;for(this.performanceData[u]||(this.performanceData[u]=[[],[],[]]),e=moment().add(-3,"minutes"),f=0;f<this.performanceData[u].length;f++)this.performanceData[u][f]=$.grep(this.performanceData[u][f],function(n){return moment(n.x).isAfter(e)});this.performanceData[u][0].push({x:moment(r).toDate(),y:i["0"]/100});this.performanceData[u][1].push({x:moment(r).toDate(),y:i["1"]});this.performanceData[u][2].push({x:moment(r).toDate(),y:i["2"]/.1})},n.prototype.removePerformanceChart=function(n){var t=n.guid(),i="chart-target-"+t;this.charts[i]&&(this.charts[i].detach(),delete this.charts[i]);$("#chart-container-"+t).remove();delete this.performanceData[t]},n.prototype.updatePerformanceChart=function(n){var u,t,i,r,f;for(console.log("updatePerformanceChart",n.guid()),u=[],t=n.guid(),i=0;i<this.performanceData[t].length;i++)this.performanceData[t][i]!=null&&u.push({name:"series"+i,data:this.performanceData[t][i]});r="chart-target-"+t;f=$("#"+r);f.length?(this.charts[r].data={series:u},this.charts[r].update()):this.charts[r]=this.createChart(t,r,{series:u})},n.prototype.createChart=function(n,t,i){var r=$(".chart-container",".performance-task-template").clone(),u;return r.attr("id","chart-container-"+n),u=$(".chart-target",r),u.attr("id",t),$(".dashboard-container").append(r),new Chartist.Line("#"+t,i,{showArea:!0,showPoint:!1,axisX:{type:Chartist.FixedScaleAxis,divisor:6,labelInterpolationFnc:function(n){return moment(n).format("HH:mm:ss")}},axisY:{type:Chartist.FixedScaleAxis,high:1,low:0,ticks:[0,.1,.25,.5,.75,.9,1],labelInterpolationFnc:function(n){return Math.round(n*100)+" %"}}})},n}();n.PerformanceTask=t}(Scoop||(Scoop={}));stringToFunction=function(n){for(var r=n.split("."),t=window||this,i=0,u=r.length;i<u;i++)t=t[r[i]];if(typeof t!="function")throw new Error("function not found");return t},function(){}(Scoop||(Scoop={}));$(function(){ko.bindingHandlers.select2=new function(){this.init=function(n,t){var r=t(),i=$(n);i.select2(r);ko.utils.domNodeDisposal.addDisposeCallback(n,function(){i.select2("destroy")})};this.update=function(n,t,i){i().selectedOptions();$(n).trigger("change")}};var n=new Scoop.ConnectionService,t=new Scoop.ConnectionViewModel(n);ko.applyBindings(t)});