function updateCurrentConnections(n){var t,r,u,i,f;for(console.log("updateCurrentConnections",n),t=0;t<_activeConnections.length;t++)r=_activeConnections[t],n[r.Guid]||disconnect(r);_currentConnections=n;u=$("#connectModalTabMyServers");u&&(i=$("ul",u),f=$("li.connect-template",i),$(".li",i).not(f).remove(),$.each(_currentConnections,function(n,t){if(!_activeConnections[t.Guid]){var r=f.clone();r.removeClass("template connect-template");r.addClass("connection-"+t.Guid);$(".connect-name",r).text(t.Name);$(".connect-uri",r).text(t.Uri);$(".connect-button",r).on("click",function(){connect(t)});$(".disconnect-button",r).on("click",function(){disconnect(t)});console.log(t);i.append(r);t.AutoConnect&&connect(t).done(function(){r.addClass("connected")})}}));console.log(_currentConnections)}function connect(n){var t,i,r;console.log("connect",n);disconnect(n);t=$.hubConnection(n.Uri);i=t.createHubProxy("performanceHub");console.log(t,i);i.on("updatePerformance",function(t,i,r){updatePerformanceData(n,t,i,r);updatePerformanceChart(n)});i.on("updatePerformanceHistory",function(t){for(var r,i=0;i<t.length;i++)r=t[i],updatePerformanceData(n,r.Name,r.Values,r.Timestamp);updatePerformanceChart(n)});return r=t.start(),r.done(function(){i.invoke("GetPerformanceHistory");_activeConnections[n.Guid]=t;var r=findServerItem(n);r.each(function(){$(this).addClass("connected")})}),r}function disconnect(n){var t,i;console.log("disconnect",n);t=_activeConnections[n.Guid];t&&(t.stop(),i=findServerItem(n),i.each(function(){$(this).removeClass("connected")}),removePerformanceChart(n),delete _activeConnections[n.Guid])}function findServerItem(n){var t=$(),i=$("#connectModalTabMyServers");return i&&(t=$("ul > li",i).filter(function(){return $(this).hasClass("connection-"+n.Guid)})),t}function updatePerformanceData(n,t,i,r){_performanceData[n.Guid]||(_performanceData[n.Guid]=[[],[],[]]);_performanceData[n.Guid][0].push({timestamp:moment(r).toDate(),value:i["0"]/100});_performanceData[n.Guid][1].push({timestamp:moment(r).toDate(),value:i["1"]});_performanceData[n.Guid][2].push({timestamp:moment(r).toDate(),value:i["2"]/.1})}function getPerformanceData(n){var r,t,i;for(_performanceData[n.Guid]||(_performanceData[n.Guid]=[[],[],[]]),r=moment().add(-3,"minutes"),t=0;t<_performanceData[n.Guid].length;t++)for(i=0;i<_performanceData[n.Guid][t].length;i++)if(moment(_performanceData[n.Guid][t][i].timestamp).isBefore(r))_performanceData[n.Guid][t].shift(),i=0;else break;return _performanceData[n.Guid]}function removePerformanceChart(n){$(".performance-"+n.Guid).remove();$(".performance-legend-"+n.Guid).remove();$(".performance-container-"+n.Guid).remove()}function updatePerformanceChart(n){var i=".performance-"+n.Guid,e=".performance-legend-"+n.Guid,r,t,u,f;$(i).length||(console.log("updatePerformanceChart creating from template",n),r=$(".template-mg-container"),t=r.clone(),t.removeClass("template template-mg-container").addClass("performance-container-"+n.Guid),u=$(".template-mg",t),u.removeClass("template template-mg").addClass("performance-"+n.Guid),f=$(".template-mg-legend",t),f.removeClass("template template-mg-legend").addClass("performance-legend-"+n.Guid),r.parent().append(t));MG.data_graphic({data:getPerformanceData(n),target:i,x_accessor:"timestamp",y_accessor:"value",height:300,full_width:!0,interpolation:"linear",format:"percentage",animate_on_load:!0,transition_on_update:!1,max_y:1,xax_count:3,xax_format:function(n){return n?moment(n).format("LT"):null},legend:["Tot. CPU","Tot. Memory","Avg. Disk sec/Transfer [100ms = 100%]"],legend_target:e,mouseover:function(n){$("tspan",i+" svg .mg-active-datapoint").first().text(moment(n.key).format("LT"))},aggregate_rollover:!0,show_secondary_x_label:!1})}var _currentConnections={},_activeConnections={},_performanceData;$(function(){var n=$("#connectModalForm");if(n)n.on("submit",function(){var n=$(this);return $.ajax({url:n.prop("action"),method:n.prop("method"),data:n.serialize()}).done(function(n){updateCurrentConnections(n)}),!1})});_performanceData=[];